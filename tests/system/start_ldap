AZ_LDAP_IMG=osixia/openldap
AZ_LDAP_CTR=company_ldap
AZ_LDAP_DOMAIN=company.cz

DOCKER="sudo docker"
DOCKER_EXEC="${DOCKER} exec -i company_ldap"

function stop_ldap
{
    ${DOCKER} rm -f company_ldap
}

function start_ldap
{
    local LDAP_DN="dc=company,dc=cz"
    local LDAP_ADMIN="cn=admin,${LDAP_DN}"
    local LDAP_ADMIN_PASSWORD="JonSn0w"
    local LDAP_ADMIN_CMD_AUTH="-x -D $LDAP_ADMIN -w $LDAP_ADMIN_PASSWORD"

    ${DOCKER} run -e LDAP_ORGANISATION="Company" -e LDAP_DOMAIN=$AZ_LDAP_DOMAIN -e LDAP_ADMIN_PASSWORD=$LDAP_ADMIN_PASSWORD -d --name $AZ_LDAP_CTR $AZ_LDAP_IMG

    sleep 2

    # cat test.conf | docker exec -i company_ldap tee /home/test.conf
    # cat employee.schema | docker exec -i company_ldap tee /etc/ldap/schema/employee.schema
    # mkdir /var/tmp/ldap.conf
    # slaptest -f test.conf -F /var/tmp/ldap.conf/
    # vim /var/tmp/ldap.conf/cn\=config/cn\=schema/cn\=\{4\}employee.ldif
    # http://www.zytrax.com/books/ldap/ch6/slapd-config.html#use-schemas
    # - remove curly braces
    # - add the suffix ",cn=schema,cn=config" to dn:
    # - add cn: below objectClass
    # - remove everything after olcObjectClasses

    echo ":::: Extending Schema with the class employee"
    ${DOCKER_EXEC} ldapadd -Y EXTERNAL -H ldapi:/// <<_EOF
dn: cn=employee,cn=schema,cn=config
objectClass: olcSchemaConfig
cn: employee
olcAttributeTypes: {0}( 1.3.6.1.4.1.42.2.27.4.1.6 NAME 'employeeRole' DESC '
 Employee role' EQUALITY caseExactMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15
  SINGLE-VALUE )
olcObjectClasses: {0}( 1.3.6.1.4.1.42.2.27.4.2.1 NAME 'employee' DESC 'Emplo
 yee' SUP organizationalPerson STRUCTURAL MUST ( cn $ employeeRole ) )
_EOF
    echo "---- DONE"

    echo ":::: Adding the Org. Unit People"
    ${DOCKER_EXEC} ldapadd $LDAP_ADMIN_CMD_AUTH <<_EOF
dn: ou=People,dc=company,dc=cz
objectClass: organizationalUnit
ou: People
description: Users
_EOF
    echo "---- DONE"

    echo ":::: Adding Jakub Filak"
    ${DOCKER_EXEC} ldapadd $LDAP_ADMIN_CMD_AUTH <<_EOF
dn: uid=jfilak,ou=People,dc=company,dc=cz
cn: Jakub Filak
objectClass: organizationalPerson
objectClass: posixAccount
objectClass: employee
sn: Filak
uid: jfilak
homeDirectory: /home/jfilak
gidNumber: 1000
uidNumber: 4269
employeeRole: super
_EOF
    echo "---- DONE"

    echo ":::: Setting password for Jakub Filak"
    ${DOCKER_EXEC} ldappasswd $LDAP_ADMIN_CMD_AUTH -s Karel "uid=jfilak,ou=People,dc=company,dc=cz"
    echo "---- DONE"

    echo ":::: Retrieve Jakub Filak data by DN"
    ldapsearch -H ldap://172.17.0.2 -b "uid=jfilak,ou=People,dc=company,dc=cz" $LDAP_ADMIN_CMD_AUTH
    echo "---- DONE"

    return
}

start_ldap

AZ_LDAP_HOSTNAME=$(${DOCKER} inspect ${AZ_LDAP_CTR} --format "{{ .NetworkSettings.IPAddress }}")
export AZ_LDAP_HOSTNAME

echo ">>> LDAP host: ${AZ_LDAP_HOSTNAME}"
